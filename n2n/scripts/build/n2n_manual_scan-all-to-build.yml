name: n2n-manual-scan-all-to-build

on:
  workflow_dispatch:
    inputs:
      force-push:
        description: "force push to registry"
        required: true
        type: boolean
        default: false

jobs:
  scan-all:
    runs-on: ubuntu-latest
    env:
      DOCKER_APP_NAME: n2n
      DOCKER_CONTEXT_PATH: n2n
    permissions:
      contents: read
      packages: write
    outputs:
      matrix_json: ${{ steps.build_version.outputs.matrix_json }}
      force_push: ${{ steps.build_version.outputs.force_push }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Check build_version
        id: build_version
        run: |
          cd n2n
          PROJECT_ROOT_DIR=$(pwd)
          echo "n2n-scan-all - PROJECT_ROOT_DIR: ${PROJECT_ROOT_DIR}"
          cd ./scripts/build
          chmod +x *.sh
          . 0x0_init_logger.sh.sh

          LOG_INFO 'scan_all_save Starting'
          1x1_scan_all_do.sh
          LOG_INFO 'scan_all_save Successful'
          force_push=${{ inputs.force-push }}

          LOG_INFO  force_push: ${force_push}
          echo "force_push=${force_push}" >> $GITHUB_OUTPUT

  build-all:
    needs: [scan-all]
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix: ${{ fromJSON(needs.scan-all.outputs.matrix_json) }}

    uses: ./.github/workflows/n2n_manual_build-publish.yml
    with:
      version_big: ${{ matrix.version_big }}
      version_small: ${{ matrix.fix_version_small }}
      version_commit: ${{ matrix.fix_version_commit }}
      version_b_s_rc: ${{ matrix.version_b_s_rc }}
      str_os_archs: ${{ matrix.str_os_archs }}
      str_download_urls: ${{ matrix.str_download_urls }}
      force_push: ${{ needs.scan-all.outputs.force_push == 'true' }}
    secrets: inherit
