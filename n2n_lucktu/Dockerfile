FROM alpine/git
FROM debian:stable-slim as downloader

ARG name="n2n-downloader"
ARG summary="Base build image for n2n_lucktu built on-top of debian:stable-slim"
LABEL description="${summary}" \
  maintainer="<zctmdc@outlook.com>" \
  app.kubernetes.io/name="${name}" \
  org.opencontainers.image.title="${name}" \
  org.opencontainers.artifact.description="${summary}" \
  org.opencontainers.image.url="https://hub.docker.com/r/zctmdc/n2n_ntop" \
  org.opencontainers.image.source="https://github.com/zctmdc/docker/tree/alpha/n2n_lucktu" \
  org.opencontainers.image.authors="zctmdc@outlook.com" \
  org.opencontainers.image.description="${summary}" \
  org.opencontainers.image.documentation="https://github.com/zctmdc/docker/tree/alpha/n2n_lucktu/doc/build.md"\
  org.opencontainers.image.licenses="MIT"

ARG DEBIAN_FRONTEND=noninteractive
RUN apt-get -qq update

RUN apt-get -qq -y install \
  bash curl wget unzip jq git

ARG CLONE
RUN [[ "$CLONE" ]] && git clone https://github.com/lucktu/n2n.git /tmp/n2n


ARG KERNEL=linux
# 用于自定义机型编译,未自动识别时请赋值
ARG MACHINE
ARG BIG_VERSION=v3
ARG SMALL_VERSION=3.1.1-16
ARG COMMIT=1200

WORKDIR /tmp/scripts/
COPY ./scripts/*.sh /tmp/scripts/
RUN chmod +x /tmp/scripts/*.sh
RUN /tmp/scripts/install_rar.sh
RUN /tmp/scripts/get_n2n.sh

FROM busybox

ARG name="n2n-lucktu"
ARG summary="n2n_lucktu built on-top of busybox"
LABEL description="${summary}" \
  maintainer="<zctmdc@outlook.com>" \
  app.kubernetes.io/name="${name}" \
  org.opencontainers.image.title="${name}" \
  org.opencontainers.artifact.description="${summary}" \
  org.opencontainers.image.url="https://hub.docker.com/r/zctmdc/n2n_ntop" \
  org.opencontainers.image.source="https://github.com/zctmdc/docker/tree/alpha/n2n_lucktu" \
  org.opencontainers.image.authors="zctmdc@outlook.com" \
  org.opencontainers.image.description="${summary}" \
  org.opencontainers.image.licenses="MIT"

COPY --from=downloader \
  /tmp/desc/supernode \
  /tmp/desc/edge \
  /usr/local/sbin/

COPY ./scripts/*.sh /usr/local/sbin/

CMD [ "/bin/bash" , "-c" , "/usr/local/sbin/run_n2n.sh" ]

HEALTHCHECK --interval=20s --timeout=10s CMD /usr/local/sbin/n2n_healthcheck.sh
